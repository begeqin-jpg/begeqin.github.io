<!-- PayPal SDK (–ù–ï –ú–ï–ù–Ø–ï–ú –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) -->
<script src="https://www.paypal.com/sdk/js?client-id=Aaqa1Uyr825beuIzTOVq2Q0Q-C1hnuS3ibuBdpBHS2CMCgt3LrXDpqJ7TPao4trHTRZWX-RZJxoUxvUj&currency=USD&intent=tokenize&commit=false&vault=true&disable-funding=credit,card"></script>

<style>
  .donate-fab{
    position:fixed; right:18px; bottom:18px;
    background:#ff5f5f; color:#fff; border:none;
    padding:12px 16px; border-radius:999px;
    font:600 14px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.25);
    z-index:9999;
  }
  .donate-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center;
    z-index:10000;
  }
  .donate-modal{
    width:min(420px, 92vw);
    background:#0f1218; color:#eaf0ff;
    border-radius:18px; padding:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
    border:1px solid rgba(255,255,255,.08);
  }
  .donate-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .donate-title{ font:700 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
  .donate-close{
    background:transparent; border:none; color:#c7d2fe;
    font-size:22px; cursor:pointer; padding:6px 10px;
  }
  .donate-sub{ margin:8px 0 14px; color:#b9c3d9; font:400 13px/1.4 system-ui; }
  .donate-amounts{ display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 12px; }
  .donate-chip{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
    color:#eaf0ff; padding:8px 10px; border-radius:999px; cursor:pointer;
    font:600 13px/1 system-ui;
  }
  .donate-chip.active{ background:rgba(255,95,95,.20); border-color:rgba(255,95,95,.55); }
  .donate-row{ display:flex; gap:10px; align-items:center; margin:10px 0; }
  .donate-input{
    width:120px; padding:10px 12px; border-radius:12px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
    color:#eaf0ff; outline:none;
    font:600 14px/1 system-ui;
  }
  .donate-note{
    flex:1;
    padding:10px 12px; border-radius:12px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
    color:#eaf0ff; outline:none;
    font:500 14px/1 system-ui;
  }
  .donate-paypal{ margin-top:12px; }
  .donate-foot{ margin-top:10px; color:#9aa7c3; font:400 12px/1.4 system-ui; }

  /* message box */
  #result-message{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    color:#eaf0ff;
    font:500 12.5px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    white-space:pre-wrap;
    display:none;
  }

  @media (max-width: 420px) {
    .donate-row { flex-direction: column; align-items: stretch; }
    .donate-input { width: 100%; }
  }
</style>

<button class="donate-fab" id="donateOpen">‚òï Support</button>

<div class="donate-backdrop" id="donateBackdrop" aria-hidden="true">
  <div class="donate-modal" role="dialog" aria-modal="true" aria-label="Donate">
    <div class="donate-head">
      <h3 class="donate-title">Support the project</h3>
      <button class="donate-close" id="donateClose" aria-label="Close">√ó</button>
    </div>
    <div class="donate-sub">Choose an amount (like ko-fi) and connect PayPal (vault/tokenize).</div>

    <div class="donate-amounts" id="amountChips">
      <button class="donate-chip active" data-amount="5">$5</button>
      <button class="donate-chip" data-amount="10">$10</button>
      <button class="donate-chip" data-amount="20">$20</button>
      <button class="donate-chip" data-amount="50">$50</button>
    </div>

    <div class="donate-row">
      <input class="donate-input" id="donateAmount" type="number" min="1" step="1" value="5" />
      <input class="donate-note" id="donateNote" type="text" maxlength="120" placeholder="Message (optional)" />
    </div>

    <div class="donate-paypal" id="paypal-button-container"></div>
    <div id="result-message"></div>

    <div class="donate-foot">PayPal Vault (tokenize). Thank you üíô</div>
  </div>
</div>

<script>
  // ---------- helpers ----------
  function resultMessage(message) {
    const el = document.querySelector("#result-message");
    if (!el) return;
    if (!message) { el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block";
    el.textContent = message;
  }
  function pretty(obj) {
    try { return typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); }
    catch { return String(obj); }
  }
  function log(...args){ console.log("[DONATE]", ...args); }

  // --- Modal open/close
  const openBtn = document.getElementById('donateOpen');
  const backdrop = document.getElementById('donateBackdrop');
  const closeBtn = document.getElementById('donateClose');

  function openDonate(){ backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden','false'); }
  function closeDonate(){ backdrop.style.display = 'none'; backdrop.setAttribute('aria-hidden','true'); }

  openBtn.addEventListener('click', () => { resultMessage(""); openDonate(); });
  closeBtn.addEventListener('click', closeDonate);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeDonate(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeDonate(); });

  // --- Amount chips
  const chipsWrap = document.getElementById('amountChips');
  const amountInput = document.getElementById('donateAmount');

  chipsWrap.addEventListener('click', (e)=>{
    const chip = e.target.closest('.donate-chip');
    if(!chip) return;
    [...chipsWrap.querySelectorAll('.donate-chip')].forEach(b=>b.classList.remove('active'));
    chip.classList.add('active');
    amountInput.value = chip.dataset.amount;
  });

  amountInput.addEventListener('input', ()=>{
    [...chipsWrap.querySelectorAll('.donate-chip')].forEach(b=>b.classList.remove('active'));
  });

  // --- PayPal Buttons (TOKENIZE / VAULT) ‚Äî ONLY Vault Setup Token flow
  (function initPayPal(){
    if (!window.paypal || !paypal.Buttons) {
      resultMessage("‚ùå PayPal SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (window.paypal –ø—É—Å—Ç–æ–π).");
      return;
    }

    const trace = () => (Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8)).toUpperCase();

    paypal.Buttons({
      style: { layout: 'vertical', label: 'paypal' },

      createVaultSetupToken: async () => {
        const t = trace();
        const note = (document.getElementById('donateNote').value || '').trim();
        const amount = Math.max(1, Math.round(Number(amountInput.value || 1)));

        resultMessage(`(${t}) Creating setup token‚Ä¶`);

        const res = await fetch("/api/paypal/create-setup-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            description: note ? (`Support ($${amount}): ${note}`) : `Support ($${amount})`,
            return_url: window.location.href,
            cancel_url: window.location.href
          })
        });

        const data = await res.json().catch(() => ({}));
        log("create-setup-token", t, res.status, data);

        if (!res.ok || !data.id) {
          resultMessage(`(${t}) ‚ùå create-setup-token failed\nHTTP ${res.status}\n` + pretty(data));
          throw new Error(data?.message || "create-setup-token failed");
        }

        resultMessage(`(${t}) ‚úÖ Setup token created\n${data.id}`);
        return data.id;
      },

      onApprove: async (data) => {
        log("onApprove", data);

        if (!data || !data.vaultSetupToken) {
          resultMessage("‚ùå Approved, but no vaultSetupToken returned.\n" + pretty(data));
          return;
        }

        resultMessage("‚úÖ Setup approved\nCreating payment token‚Ä¶");

        const res = await fetch("/api/paypal/create-payment-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ vaultSetupToken: data.vaultSetupToken })
        });

        const out = await res.json().catch(() => ({}));
        log("create-payment-token", res.status, out);

        if (!res.ok || !out.id) {
          resultMessage("‚ùå create-payment-token failed\nHTTP " + res.status + "\n" + pretty(out));
          return;
        }

        try { localStorage.setItem("paypal_payment_token_id", out.id); } catch(e) {}
        resultMessage("‚úÖ Saved (PaymentTokenID):\n" + out.id);
      },

      onError: (err) => {
        log("PayPal onError", err);

        // –í–ê–ñ–ù–û: –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert ‚Äî –æ–Ω —Å–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏.
        // –ü–æ–∫–∞–∂–µ–º –≤—Å—ë –≤ –º–æ–¥–∞–ª–∫–µ.
        const msg = (err && (err.message || err.toString())) ? (err.message || err.toString()) : "Unknown error";
        resultMessage("‚ùå PayPal SDK error:\n" + msg + "\n\nRaw:\n" + pretty(err));
      }
    }).render("#paypal-button-container");
  })();
</script>
